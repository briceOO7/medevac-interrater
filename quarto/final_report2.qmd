---
title: "Physician Medevac Propensity Analysis"
subtitle: "Comprehensive Analysis of Clinical Appropriateness and Practice Variation"
author: "Medevac Interrater Study Team"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    theme: cosmo
    fig-width: 12
    fig-height: 8
    self-contained: true
    code-fold: true
    echo: false
  pdf:
    toc: true
    toc-depth: 3
    number-sections: true
    colorlinks: true
    fig-width: 12
    fig-height: 8
    keep-tex: false
    echo: false
    include-in-header:
      text: |
        \usepackage{xcolor}
        \definecolor{darkgreen}{RGB}{0,100,0}
        \definecolor{orange}{RGB}{255,165,0}
---

```{r setup}
#| include: false
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8
)

# Load libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
library(here)
library(lme4)
library(gridExtra)
library(irrCAC)

# Load raw survey data for affiliations
raw_data <- read.csv(here::here("data", "survey_results.csv"), 
                     stringsAsFactors = FALSE)

# Load main processed data
data <- read.csv(here::here("data", "processed", "survey_data_processed.csv"),
                 stringsAsFactors = FALSE)

# Load medevac normative mapping (SIMPLIFIED - 3 categories)
medevac_mapping <- read.csv(here::here("data", "medevac_normative_mapping_simplified.csv"),
                             stringsAsFactors = FALSE)

# Load physician experience data
physician_experience <- read.csv(here::here("data", "physician_experience.csv"),
                                 stringsAsFactors = FALSE)

# Load practice location data
practice_location <- read.csv(here::here("data", "practice_location.csv"),
                             stringsAsFactors = FALSE)

# Merge with main data
data <- data %>%
  left_join(medevac_mapping %>% select(question, medevac_normative_status, medevac_status_label),
            by = "question") %>%
  left_join(physician_experience %>% select(physician_id, years_experience),
            by = "physician_id") %>%
  left_join(practice_location %>% select(physician_id, practice_location),
            by = "physician_id")

# Create binary outcomes and centered predictors
data <- data %>%
  mutate(
    # Primary outcome: chose medevac vs. not
    chose_medevac = ifelse(decision == "Medevac", 1, 0),
    # Set factor levels with Possible Medevac as reference (4 categories)
    medevac_status_label = factor(medevac_status_label,
                                   levels = c("Possible Medevac",
                                            "Never Medevac",
                                            "Special Considerations",
                                            "Always Medevac")),
    # Factor practice location with Referral Hub as reference
    practice_location = factor(practice_location, 
                              levels = c("Referral Hub", "Regional Hub", "Mixed"))
  )

# Calculate within-between decomposition for confidence
physician_mean_confidence <- data %>%
  group_by(physician_id) %>%
  summarise(physician_mean_conf = mean(confidence, na.rm = TRUE)) %>%
  ungroup()

grand_mean_confidence <- mean(data$confidence, na.rm = TRUE)

data <- data %>%
  left_join(physician_mean_confidence, by = "physician_id") %>%
  mutate(
    # Within-person: Deviation from own mean
    confidence_within = confidence - physician_mean_conf,
    # Between-person: Physician's mean relative to grand mean
    confidence_between = physician_mean_conf - grand_mean_confidence,
    # Years experience (grand-mean centered)
    years_experience_centered = years_experience - mean(years_experience, na.rm = TRUE)
  )
```

# Executive Summary

This report examines physician variation in medevac decision-making through the lens of **clinical appropriateness**, with explicit modeling of **confidence** and **years of experience**.

We categorize all 20 vignettes by **vignette type** (appropriateness of the medevac option):

- **Always Medevac** (n=4): Medevac is clearly the best answer
- **Possible Medevac** (n=9): Medevac may or may not be appropriate depending on clinical judgment
- **Special Considerations** (n=3): Medevac or Remain are both reasonable; conflict between physiology and logistics
- **Never Medevac** (n=4): Medevac is clearly not appropriate

**Statistical Model**: Binary mixed-effects logistic regression
- Outcome: Chose medevac vs. not
- Fixed effects: Vignette type + Confidence (centered) + Experience (centered)
- Random effects: Physician + Vignette
- No interaction terms (for simplicity)

**Key Findings:**

1. **Strong appropriateness gradient**
   - Odds of choosing medevac increase systematically from "Never Medevac" to "Always Medevac"
   - Strong evidence of appropriate clinical reasoning

2. **Confidence and experience effects**
   - Confidence significantly predicts medevac choice
   - Experience shows positive trend
   - Together explain meaningful physician variance

3. **Substantial residual variation persists**
   - Even after accounting for appropriateness, confidence, and experience
   - Suggests additional unmeasured factors influence decision-making

---

# Table 1: Sample Characteristics and Study Design

```{r table1-expanded}

# Vignette counts by vignette type
normative_counts <- data %>%
  distinct(question, medevac_status_label) %>%
  count(medevac_status_label) %>%
  arrange(factor(medevac_status_label, 
                 levels = c("Never Medevac", "Possible Medevac", "Special Considerations", "Always Medevac")))

# Calculate agreement statistics by vignette
agreement_by_vignette <- data %>%
  group_by(question) %>%
  summarise(
    n = n(),
    pct_medevac = 100 * sum(decision == "Medevac") / n,
    pct_commercial = 100 * sum(decision == "Commercial") / n,
    pct_remain = 100 * sum(decision == "Remain") / n,
    .groups = "drop"
  ) %>%
  mutate(
    # Find modal decision
    modal_decision = case_when(
      pct_medevac >= pct_commercial & pct_medevac >= pct_remain ~ "Medevac",
      pct_commercial >= pct_medevac & pct_commercial >= pct_remain ~ "Commercial",
      TRUE ~ "Remain"
    ),
    # Calculate agreement percentage (% choosing modal)
    agreement_pct = case_when(
      modal_decision == "Medevac" ~ pct_medevac,
      modal_decision == "Commercial" ~ pct_commercial,
      modal_decision == "Remain" ~ pct_remain
    )
  )

# Categorize vignettes by agreement level
agreement_categories <- agreement_by_vignette %>%
  mutate(
    agreement_cat = case_when(
      agreement_pct == 100 ~ "100%",
      agreement_pct >= 75 ~ "75-99%",
      agreement_pct >= 50 ~ "50-74%",
      TRUE ~ "<50%"
    )
  ) %>%
  count(agreement_cat)

# Create physician summary statistics
physician_summary <- data %>%
  group_by(physician_id) %>%
  summarise(
    years_experience = first(years_experience),
    practice_location = first(practice_location),
    n_responses = n(),
    n_medevac = sum(decision == "Medevac"),
    pct_medevac = 100 * mean(decision == "Medevac")
  )

# Calculate practice location counts
location_summary <- physician_summary %>%
  count(practice_location)

n_physicians <- length(unique(data$physician_id))
n_regional <- location_summary %>% filter(practice_location == "Regional Hub") %>% pull(n)
n_referral <- location_summary %>% filter(practice_location == "Referral Hub") %>% pull(n)
n_mixed <- location_summary %>% filter(practice_location == "Mixed") %>% pull(n)
pct_regional <- 100 * n_regional / n_physicians
pct_referral <- 100 * n_referral / n_physicians
pct_mixed <- 100 * n_mixed / n_physicians

# Calculate correct responses to Always/Never Medevac vignettes
correct_responses <- data %>%
  mutate(
    correct_always = ifelse(medevac_status_label == "Always Medevac" & decision == "Medevac", 1, 0),
    correct_never = ifelse(medevac_status_label == "Never Medevac" & decision != "Medevac", 1, 0),
    n_always_vignettes = ifelse(medevac_status_label == "Always Medevac", 1, 0),
    n_never_vignettes = ifelse(medevac_status_label == "Never Medevac", 1, 0)
  ) %>%
  summarise(
    n_correct_always = sum(correct_always),
    n_always_total = sum(n_always_vignettes),
    pct_correct_always = 100 * n_correct_always / n_always_total,
    n_correct_never = sum(correct_never),
    n_never_total = sum(n_never_vignettes),
    pct_correct_never = 100 * n_correct_never / n_never_total
  )

# Build comprehensive table manually to avoid mismatch
# New order: Physicians, Years in Practice, Vignettes, Total Responses, Inter-Rater, Confidence
chars <- c(
  "**Physicians**",
  "  Total Physicians",
  "",
  "**Years in Practice**",
  "  Median [IQR]",
  "  Range",
  "",
  "**Practice Location**",
  "  Regional Hub",
  "  Referral Hub (ANMC)",
  "  Mixed",
  "",
  "**Vignettes**",
  "  Total Vignettes"
)

vals <- c(
  "",
  as.character(n_physicians),
  "",
  "",
  sprintf("%.0f [%.0f - %.0f]", 
          median(physician_summary$years_experience),
          quantile(physician_summary$years_experience, 0.25),
          quantile(physician_summary$years_experience, 0.75)),
  sprintf("%d - %d years", 
          min(physician_summary$years_experience),
          max(physician_summary$years_experience)),
  "",
  "",
  sprintf("%d (%.0f%%)", n_regional, pct_regional),
  sprintf("%d (%.0f%%)", n_referral, pct_referral),
  sprintf("%d (%.0f%%)", n_mixed, pct_mixed),
  "",
  "",
  as.character(length(unique(data$question)))
)

# Add vignette normative counts
for(i in 1:nrow(normative_counts)) {
  chars <- c(chars, paste0("  ", normative_counts$medevac_status_label[i]))
  vals <- c(vals, sprintf("%d", normative_counts$n[i]))
}

# Add rest
chars <- c(chars, "",
           "**Responses**",
           "  Total Responses",
           "  Correct Responses to Always Medevac",
           "  Correct Responses to Never Medevac",
           "",
           "**Inter-Rater Agreement by Vignette**",
           "  Median [IQR]",
           "  Range",
           "  100% Agreement",
           "  75-99% Agreement",
           "  50-74% Agreement",
           "  <50% Agreement",
           "",
           "**Confidence (1-10 scale)**",
           "  Median [IQR]",
           "  Range")

vals <- c(vals, "",
          "",
          as.character(nrow(data)),
          sprintf("%.1f%% (n=%d)", correct_responses$pct_correct_always, correct_responses$n_correct_always),
          sprintf("%.1f%% (n=%d)", correct_responses$pct_correct_never, correct_responses$n_correct_never),
          "",
          "",
          sprintf("%.1f%% [%.1f%% - %.1f%%]", 
                  median(agreement_by_vignette$agreement_pct),
                  quantile(agreement_by_vignette$agreement_pct, 0.25),
                  quantile(agreement_by_vignette$agreement_pct, 0.75)),
          sprintf("%.1f%% - %.1f%%", 
                  min(agreement_by_vignette$agreement_pct),
                  max(agreement_by_vignette$agreement_pct)),
          sprintf("%d vignettes", ifelse(any(agreement_categories$agreement_cat == "100%"), 
                                          agreement_categories$n[agreement_categories$agreement_cat == "100%"], 0)),
          sprintf("%d vignettes", ifelse(any(agreement_categories$agreement_cat == "75-99%"), 
                                          agreement_categories$n[agreement_categories$agreement_cat == "75-99%"], 0)),
          sprintf("%d vignettes", ifelse(any(agreement_categories$agreement_cat == "50-74%"), 
                                          agreement_categories$n[agreement_categories$agreement_cat == "50-74%"], 0)),
          sprintf("%d vignettes", ifelse(any(agreement_categories$agreement_cat == "<50%"), 
                                          agreement_categories$n[agreement_categories$agreement_cat == "<50%"], 0)),
          "",
          "",
          sprintf("%.0f [%.0f - %.0f]", 
                  median(data$confidence, na.rm = TRUE),
                  quantile(data$confidence, 0.25, na.rm = TRUE),
                  quantile(data$confidence, 0.75, na.rm = TRUE)),
          sprintf("%.0f - %.0f", 
                  min(data$confidence, na.rm = TRUE),
                  max(data$confidence, na.rm = TRUE)))

summary_stats <- data.frame(
  Characteristic = chars,
  Value = vals
)

kable(summary_stats,
      col.names = c("Characteristic", "Value"),
      caption = "Table 1: Sample Characteristics and Study Design",
      escape = FALSE) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "left"
  )
```

---

# Figure 1: Response Distribution by Physician

```{r create-physician-letter-mapping}
# Create experience quartile-based labeling for physicians
# Get unique physicians with their experience
physician_exp <- data %>%
  distinct(physician_id, years_experience) %>%
  arrange(years_experience)

# Calculate experience quartiles
exp_quartiles <- quantile(physician_exp$years_experience, probs = c(0, 0.25, 0.5, 0.75, 1.0))

# Assign quartile labels and sequential numbers within each quartile
physician_letter_map <- physician_exp %>%
  mutate(
    quartile = cut(years_experience,
                   breaks = exp_quartiles,
                   labels = c("A", "B", "C", "D"),
                   include.lowest = TRUE)
  ) %>%
  group_by(quartile) %>%
  mutate(
    quartile_num = row_number(),
    physician_letter = paste0(quartile, quartile_num)
  ) %>%
  ungroup() %>%
  select(physician_id, physician_letter, quartile, years_experience)

# Store quartile ranges for legend
quartile_ranges <- data.frame(
  quartile = c("A", "B", "C", "D"),
  range_text = c(
    sprintf("A = %.0f-%.0f years", floor(exp_quartiles[1]), floor(exp_quartiles[2])),
    sprintf("B = %.0f-%.0f years", floor(exp_quartiles[2])+1, floor(exp_quartiles[3])),
    sprintf("C = %.0f-%.0f years", floor(exp_quartiles[3])+1, floor(exp_quartiles[4])),
    sprintf("D = %.0f+ years", floor(exp_quartiles[4])+1)
  )
)
legend_text <- paste(quartile_ranges$range_text, collapse = ", ")
```

```{r figure1-physician-horizontal}
#| fig-height: 10
#| fig-width: 12

# Calculate proportion of each decision type for each physician
physician_decisions <- data %>%
  left_join(physician_letter_map, by = "physician_id") %>%
  group_by(physician_letter) %>%
  summarise(
    Medevac = sum(decision == "Medevac"),
    Commercial = sum(decision == "Commercial"),
    Remain = sum(decision == "Remain"),
    Total = n()
  ) %>%
  mutate(
    pct_medevac = 100 * Medevac / Total,
    pct_commercial = 100 * Commercial / Total,
    pct_remain = 100 * Remain / Total
  ) %>%
  arrange(desc(pct_medevac))

# Create long format for stacked bar
physician_long <- physician_decisions %>%
  select(Physician = physician_letter, Medevac = pct_medevac, 
         Commercial = pct_commercial, Remain = pct_remain) %>%
  pivot_longer(cols = c(Medevac, Commercial, Remain), 
               names_to = "Decision", values_to = "Percentage")

# Ensure correct factor ordering for stacking
physician_long$Decision <- factor(physician_long$Decision,
                                  levels = c("Remain", "Commercial", "Medevac"))

# Reorder physicians by total medevac percentage
physician_order <- physician_decisions %>%
  arrange(pct_medevac) %>%
  pull(physician_letter)

physician_long$Physician <- factor(physician_long$Physician, levels = physician_order)

# Create horizontal stacked bar chart
ggplot(physician_long, aes(x = Physician, y = Percentage, fill = Decision)) +
  geom_col(position = "stack", width = 0.8) +
  coord_flip() +
  scale_fill_manual(
    values = c("Medevac" = "#E74C3C", "Commercial" = "#3498DB", "Remain" = "#2ECC71"),
    name = "Decision",
    breaks = c("Medevac", "Commercial", "Remain"),
    labels = c("Medevac", "Commercial", "Remain")
  ) +
  labs(
    title = "Figure 1: Response Distribution by Physician",
    y = "Proportion of Responses (%)",
    x = "Physician",
    fill = "Decision"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0, 100),
                     breaks = seq(0, 100, 25)) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 9, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    plot.caption = element_text(size = 11, hjust = 0.5, face = "bold")
  ) +
  labs(caption = paste("Physician labels indicate experience quartile:", legend_text))
```

---

# Table 2: Descriptive Statistics by Vignette

```{r table2-combined}
# Use medevac_status_label directly (matches Table 1 classification)
vignette_desc <- data %>%
  group_by(question, medevac_status_label, question_type, vignette_class) %>%
  summarise(
    n = n(),
    n_medevac = sum(decision == "Medevac"),
    n_commercial = sum(decision == "Commercial"),
    n_remain = sum(decision == "Remain"),
    pct_medevac = 100 * n_medevac / n,
    pct_commercial = 100 * n_commercial / n,
    pct_remain = 100 * n_remain / n,
    median_confidence = median(confidence, na.rm = TRUE),
    q25_confidence = quantile(confidence, 0.25, na.rm = TRUE),
    q75_confidence = quantile(confidence, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    # Create subclass names from original final_report
    # Reclassify D as B first
    vignette_class = ifelse(vignette_class == "D", "B", vignette_class),
    vignette_type = case_when(
      vignette_class == "A" & question_type == "Clear Medevac" ~ "Best Choice Medevac",
      vignette_class == "A" & question_type == "Clear Commercial" ~ "Best Choice Commercial",
      vignette_class == "A" & question_type == "Clear Remain" ~ "Best Choice Remain",
      vignette_class == "B" & question_type == "Clear Not Medevac" ~ "Commercial or Remain",
      vignette_class == "B" & question_type == "Clear Not Remain" ~ "Medevac or Commercial",
      vignette_class == "B" & grepl("Conflict", question_type) ~ "Special Situation: Medevac or Remain",
      vignette_class == "C" ~ "All Options Reasonable",
      TRUE ~ as.character(question_type)
    ),
    # Find modal decision
    modal_decision = case_when(
      pct_medevac >= pct_commercial & pct_medevac >= pct_remain ~ "Medevac",
      pct_commercial >= pct_medevac & pct_commercial >= pct_remain ~ "Commercial",
      TRUE ~ "Remain"
    ),
    # Calculate agreement percentage (% choosing modal)
    agreement_pct = case_when(
      modal_decision == "Medevac" ~ pct_medevac,
      modal_decision == "Commercial" ~ pct_commercial,
      modal_decision == "Remain" ~ pct_remain
    ),
    # Format display strings
    medevac_display = sprintf("%.1f%% (n=%d)", pct_medevac, n_medevac),
    commercial_display = sprintf("%.1f%% (n=%d)", pct_commercial, n_commercial),
    remain_display = sprintf("%.1f%% (n=%d)", pct_remain, n_remain),
    conf_display = sprintf("%.0f [%.0f-%.0f]", median_confidence, q25_confidence, q75_confidence)
  )

# Calculate Gwet's AC1 for each vignette (FIXED - using approach from final_report)
# Create wide format: one row per vignette, one column per physician
ratings_wide <- data %>%
  select(question, physician_id, decision) %>%
  pivot_wider(
    id_cols = question,
    names_from = physician_id,
    values_from = decision,
    names_prefix = "Physician_"
  )

ac1_by_vignette <- data %>%
  group_by(question) %>%
  summarise(
    decisions_vec = list(decision[!is.na(decision)]),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(
    decisions_vec = list(unlist(decisions_vec)),
    n_decisions = length(decisions_vec),
    n_unique = length(unique(decisions_vec)),
    
    gwet_ac1 = {
      if (n_decisions == 0 || n_unique <= 1) {
        if (n_decisions > 0 && n_unique == 1) {
          1.0  # Perfect agreement
        } else {
          NA_real_  # Cannot compute
        }
      } else {
        # Convert to numeric codes (1=Medevac, 2=Commercial, 3=Remain)
        decision_codes <- as.numeric(factor(decisions_vec, levels = c("Medevac", "Commercial", "Remain")))
        
        # Create ratings matrix: 1 row (one vignette), multiple columns (raters/physicians)
        ratings_matrix <- matrix(decision_codes, nrow = 1)
        
        # Calculate Gwet's AC1
        ac1_result <- tryCatch({
          result <- gwet.ac1.raw(ratings_matrix)
          round(result$est$coeff.val, 3)
        }, error = function(e) {
          NA_real_
        })
        ac1_result
      }
    },
    
    ac1_interpretation = case_when(
      is.na(gwet_ac1) && n_decisions == 0 ~ "Cannot compute",
      !is.na(gwet_ac1) && gwet_ac1 == 1.0 ~ "Perfect",
      is.na(gwet_ac1) ~ "Cannot compute",
      gwet_ac1 < 0.00 ~ "None",
      gwet_ac1 <= 0.20 ~ "Slight",
      gwet_ac1 <= 0.40 ~ "Fair",
      gwet_ac1 <= 0.60 ~ "Moderate",
      gwet_ac1 <= 0.80 ~ "Good",
      gwet_ac1 <= 0.99 ~ "Very Good",
      TRUE ~ "Perfect"
    )
  ) %>%
  ungroup() %>%
  select(question, gwet_ac1, ac1_interpretation)

# Join AC1 results to vignette_desc
vignette_desc <- vignette_desc %>%
  left_join(ac1_by_vignette, by = "question")

# Create display table with proper ordering
table2_display <- vignette_desc %>%
  # Arrange by medevac_status_label to ensure proper grouping
  arrange(factor(medevac_status_label, 
                 levels = c("Never Medevac", "Possible Medevac", "Special Considerations", "Always Medevac")),
          question) %>%
  select(
    `Vignette Type` = vignette_type,
    `Q#` = question,
    `Medevac` = medevac_display,
    `Commercial` = commercial_display,
    `Remain` = remain_display,
    `Modal` = modal_decision,
    `Agreement %` = agreement_pct,
    `Median Conf. [IQR]` = conf_display,
    # Keep medevac_status_label for grouping
    medevac_status = medevac_status_label
  )

# Calculate row indices for each group
row_groups <- table2_display %>%
  mutate(row_num = row_number()) %>%
  group_by(medevac_status) %>%
  summarise(
    start = min(row_num),
    end = max(row_num),
    .groups = "drop"
  )

# Create base table
table2_kable <- kable(table2_display %>% select(-medevac_status),
      caption = "Table 2: Descriptive Statistics by Vignette",
      align = c("l", "r", "l", "l", "l", "l", "r", "l")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "left"
  ) %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(7, bold = TRUE,
              color = ifelse(table2_display$`Agreement %` >= 75, "darkgreen",
                           ifelse(table2_display$`Agreement %` >= 50, "orange", "red")))

# Add pack_rows for each group
for (i in 1:nrow(row_groups)) {
  group_name <- as.character(row_groups$medevac_status[i])
  table2_kable <- table2_kable %>%
    pack_rows(group_name, row_groups$start[i], row_groups$end[i])
}

table2_kable
```

**Table 2 Notes:**
- **Median Conf. [IQR]**: Median confidence rating with interquartile range (1-10 scale)
- Vignettes grouped by vignette type (matching Table 1 classification)

---

## Figure 2: Agreement, Confidence, and Decision Distribution by Vignette Type

```{r figure2-combined-lines}
#| fig-height: 7
#| fig-width: 12

# Calculate summary statistics by vignette type
vignette_summary <- data %>%
  left_join(agreement_by_vignette %>% select(question, agreement_pct), by = "question") %>%
  group_by(medevac_status_label) %>%
  summarise(
    n_vignettes = n_distinct(question),
    mean_agreement = mean(agreement_pct, na.rm = TRUE),
    se_agreement = sd(agreement_pct, na.rm = TRUE) / sqrt(n_distinct(question)),
    mean_confidence = mean(confidence, na.rm = TRUE),
    se_confidence = sd(confidence, na.rm = TRUE) / sqrt(n()),
    pct_medevac = 100 * mean(decision == "Medevac"),
    se_medevac = 100 * sd(decision == "Medevac") / sqrt(n()),
    pct_commercial = 100 * mean(decision == "Commercial"),
    se_commercial = 100 * sd(decision == "Commercial") / sqrt(n()),
    pct_remain = 100 * mean(decision == "Remain"),
    se_remain = 100 * sd(decision == "Remain") / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    # Scale confidence to 0-100 scale for comparability
    confidence_scaled = mean_confidence * 10,
    confidence_lower = (mean_confidence - 1.96 * se_confidence) * 10,
    confidence_upper = (mean_confidence + 1.96 * se_confidence) * 10,
    agreement_lower = mean_agreement - 1.96 * se_agreement,
    agreement_upper = mean_agreement + 1.96 * se_agreement,
    medevac_lower = pct_medevac - 1.96 * se_medevac,
    medevac_upper = pct_medevac + 1.96 * se_medevac,
    commercial_lower = pct_commercial - 1.96 * se_commercial,
    commercial_upper = pct_commercial + 1.96 * se_commercial,
    remain_lower = pct_remain - 1.96 * se_remain,
    remain_upper = pct_remain + 1.96 * se_remain,
    category_num = row_number()
  )

# Reshape for plotting
plot_data <- vignette_summary %>%
  select(medevac_status_label, category_num, 
         Agreement = mean_agreement, agreement_lower, agreement_upper,
         `Confidence (scaled)` = confidence_scaled, confidence_lower, confidence_upper,
         `% Medevac` = pct_medevac, medevac_lower, medevac_upper,
         `% Commercial` = pct_commercial, commercial_lower, commercial_upper,
         `% Remain` = pct_remain, remain_lower, remain_upper) %>%
  pivot_longer(
    cols = c(Agreement, `Confidence (scaled)`, `% Medevac`, `% Commercial`, `% Remain`),
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  mutate(
    Lower = case_when(
      Metric == "Agreement" ~ agreement_lower,
      Metric == "Confidence (scaled)" ~ confidence_lower,
      Metric == "% Medevac" ~ medevac_lower,
      Metric == "% Commercial" ~ commercial_lower,
      Metric == "% Remain" ~ remain_lower
    ),
    Upper = case_when(
      Metric == "Agreement" ~ agreement_upper,
      Metric == "Confidence (scaled)" ~ confidence_upper,
      Metric == "% Medevac" ~ medevac_upper,
      Metric == "% Commercial" ~ commercial_upper,
      Metric == "% Remain" ~ remain_upper
    ),
    LineType = ifelse(Metric %in% c("Agreement", "Confidence (scaled)"), "solid", "dashed")
  )

ggplot(plot_data, aes(x = category_num, y = Value, color = Metric, group = Metric, linetype = LineType)) +
  geom_line(size = 1.5) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), 
                width = 0.2, size = 1, alpha = 0.7) +
  scale_color_manual(
    values = c("Agreement" = "#3498DB",
               "Confidence (scaled)" = "#E67E22",
               "% Medevac" = "#27AE60",
               "% Commercial" = "#9B59B6",
               "% Remain" = "#E74C3C"),
    name = NULL
  ) +
  scale_linetype_identity() +
  labs(
    title = "Figure 2: Agreement, Confidence, and Decision Distribution by Vignette Type",
    subtitle = "Note: Confidence rescaled to 0-100 scale for comparison (original 1-10 scale × 10)",
    x = "Vignette Type",
    y = "Percentage / Scaled Score"
  ) +
  scale_x_continuous(
    breaks = 1:4,
    labels = c("Never\nMedevac", "Possible\nMedevac", "Special\nConsiderations", "Always\nMedevac")
  ) +
  scale_y_continuous(limits = c(0, 105), breaks = seq(0, 100, 20)) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10, color = "gray30"),
    axis.title = element_text(face = "bold", size = 12),
    axis.text.x = element_text(size = 10),
    legend.position = "bottom",
    legend.text = element_text(size = 11),
    panel.grid.minor = element_blank()
  )
```

**Key Patterns:**
- **Agreement** (blue, solid): Higher on clear-cut cases (Always/Never Medevac)
- **Confidence** (orange, solid): Highest when medevac is clearly indicated (Always Medevac)
- **Decision patterns** (dashed lines):
  - **% Medevac** (green): Strong gradient from Never (0%) to Always (100%)
  - **% Commercial** (purple): Higher for intermediate scenarios
  - **% Remain** (red): Higher when medevac is not indicated
- Error bars show 95% confidence intervals

---

## Figure 3: Confidence and Agreement by Vignette

```{r figure3-confidence-agreement}
# Calculate vignette-level confidence and agreement
vignette_conf_agree <- data %>%
  left_join(agreement_by_vignette %>% select(question, agreement_pct, modal_decision),
            by = "question") %>%
  group_by(question, medevac_status_label, agreement_pct) %>%
  summarise(
    mean_confidence = mean(confidence, na.rm = TRUE),
    median_confidence = median(confidence, na.rm = TRUE),
    sd_confidence = sd(confidence, na.rm = TRUE),
    n_responses = n(),
    .groups = "drop"
  )

# Calculate correlation
cor_pearson <- cor.test(vignette_conf_agree$agreement_pct, 
                        vignette_conf_agree$mean_confidence, 
                        method = "pearson")
cor_spearman <- cor.test(vignette_conf_agree$agreement_pct, 
                         vignette_conf_agree$mean_confidence, 
                         method = "spearman")

# Create scatter plot
ggplot(vignette_conf_agree, aes(x = agreement_pct, y = mean_confidence, 
                                 color = medevac_status_label)) +
  geom_point(size = 4, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "gray30", linetype = "dashed", linewidth = 0.8) +
  geom_text(aes(label = paste0("Q", question)), 
            hjust = -0.2, vjust = -0.5, size = 3, show.legend = FALSE) +
  scale_color_manual(
    values = c("Never Medevac" = "#E74C3C",
               "Possible Medevac" = "#95A5A6",
               "Special Considerations" = "#F39C12",
               "Always Medevac" = "#27AE60"),
    name = "Vignette Type"
  ) +
  labs(
    title = "Figure 3: Confidence and Agreement by Vignette",
    subtitle = sprintf("Pearson r = %.2f (p = %.3f) | Spearman rho = %.2f (p = %.3f)",
                      cor_pearson$estimate, cor_pearson$p.value,
                      cor_spearman$estimate, cor_spearman$p.value),
    x = "Inter-Rater Agreement (%)",
    y = "Mean Confidence (1-10 scale)",
    caption = "Each point represents one vignette. Dashed line shows linear regression."
  ) +
  scale_x_continuous(limits = c(40, 105), breaks = seq(40, 100, 10)) +
  scale_y_continuous(limits = c(5, 10), breaks = seq(5, 10, 1)) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 11, color = "gray30"),
    plot.caption = element_text(hjust = 0.5, size = 10, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
```

**Key Findings:**

- **Correlation**: `r ifelse(cor_pearson$p.value < 0.05, sprintf("Significant positive correlation (r = %.2f, p = %.3f)", cor_pearson$estimate, cor_pearson$p.value), sprintf("No significant correlation (r = %.2f, p = %.2f)", cor_pearson$estimate, cor_pearson$p.value))`
- **Interpretation**: `r ifelse(cor_pearson$estimate > 0.3 & cor_pearson$p.value < 0.05, "Physicians are more confident on vignettes with higher agreement, suggesting appropriate calibration.", ifelse(abs(cor_pearson$estimate) < 0.3, "Confidence levels are relatively independent of agreement, suggesting physicians maintain consistent confidence across vignettes.", "Unexpected pattern warrants further investigation."))`

---

# Primary Analysis

## Mixed-Effects Model: Vignette Type + Confidence + Experience

```{r model-primary}
# Check correlation between experience and confidence
cor_exp_conf <- cor(data$years_experience, data$confidence, use = "complete.obs")

# Primary model: vignette type + confidence (within/between) + experience + practice location
model_primary <- glmer(chose_medevac ~ medevac_status_label + 
                  confidence_within +
                  confidence_between +
                  years_experience_centered +
                  practice_location +
                  (1 | physician_id) + (1 | question),
                data = data,
                family = binomial(link = "logit"),
                control = glmerControl(optimizer = "bobyqa"))

# Extract variance components
vc <- as.data.frame(VarCorr(model_primary))
var_physician <- vc$vcov[vc$grp == "physician_id"]
var_vignette <- vc$vcov[vc$grp == "question"]
var_residual <- pi^2 / 3  # Logistic distribution residual variance
total_var <- var_physician + var_vignette + var_residual
icc_physician <- var_physician / total_var
icc_vignette <- var_vignette / total_var
mor_physician <- exp(sqrt(2 * var_physician) * qnorm(0.75))
mor_vignette <- exp(sqrt(2 * var_vignette) * qnorm(0.75))

# Get fixed effects
fixed_effects <- fixef(model_primary)
se <- sqrt(diag(vcov(model_primary)))
or <- exp(fixed_effects)
or_lower <- exp(fixed_effects - 1.96 * se)
or_upper <- exp(fixed_effects + 1.96 * se)

# Store specific CIs for inline text (avoids repeated confint() calls)
ci_always_medevac <- c(or_lower["medevac_status_labelAlways Medevac"], 
                       or_upper["medevac_status_labelAlways Medevac"])
ci_conf_within <- c(or_lower["confidence_within"], or_upper["confidence_within"])
ci_mixed_location <- c(or_lower["practice_locationMixed"], or_upper["practice_locationMixed"])
```

**Note:** Confidence is decomposed into within-person (deviation from own average) and between-person (overall confidence level) effects using the within-between decomposition approach. This separates the effect of "being more confident than usual on this vignette" from "being a generally confident physician."

**Why Generalized Linear Mixed Models (GLMM)?**

We use a mixed-effects logistic regression model to account for the nested structure of our data: multiple responses from each physician across multiple vignettes. Standard logistic regression would violate the assumption of independent observations, as responses from the same physician are more similar to each other than to responses from other physicians, and responses to the same vignette are correlated across physicians. The GLMM approach includes random intercepts for both physicians and vignettes, allowing us to: (1) obtain valid standard errors and p-values that account for clustering, (2) separate within-physician effects (e.g., being more confident than usual) from between-physician effects (e.g., generally confident physicians), and (3) quantify how much variation exists at the physician vs. vignette level beyond what's explained by our measured predictors.

## Table 3: Model Results - All Fixed Effects

```{r table3-model-fixed}
# Calculate p-values
z_scores <- fixed_effects / se
p_values <- 2 * (1 - pnorm(abs(z_scores)))

fixed_table <- data.frame(
  Predictor = c(
    "**Vignette Type**",
    "  Possible Medevac (reference)",
    "  Never Medevac",
    "  Special Considerations",
    "  Always Medevac",
    "",
    "**Physician Characteristics**",
    "  Years of Experience (per 1-year increase)",
    "  Confidence (compared to average physician)",
    "  Practice Location:",
    "    Referral Hub (reference)",
    "    Regional Hub",
    "    Mixed",
    "",
    "**Decision Characteristics**",
    "  Confidence (compared to average response for each physician)"
  ),
  OR = c(NA, 1.00, or[2:4], NA, NA, or[7], or[6], NA, 1.00, or[8], or[9], NA, NA, or[5]),
  CI_lower = c(NA, NA, or_lower[2:4], NA, NA, or_lower[7], or_lower[6], NA, NA, or_lower[8], or_lower[9], NA, NA, or_lower[5]),
  CI_upper = c(NA, NA, or_upper[2:4], NA, NA, or_upper[7], or_upper[6], NA, NA, or_upper[8], or_upper[9], NA, NA, or_upper[5]),
  p_value_raw = c(NA, NA, p_values[2:4], NA, NA, p_values[7], p_values[6], NA, NA, p_values[8], p_values[9], NA, NA, p_values[5])
) %>%
  mutate(
    OR_display = case_when(
      Predictor %in% c("**Vignette Type**", "", "**Physician Characteristics**", "**Decision Characteristics**", "  Practice Location:") ~ "",
      Predictor %in% c("  Possible Medevac (reference)", "    Referral Hub (reference)") ~ "1.00",
      !is.na(OR) ~ sprintf("%.2f", OR),
      TRUE ~ ""
    ),
    CI_display = case_when(
      Predictor %in% c("**Vignette Type**", "", "**Physician Characteristics**", "**Decision Characteristics**", "  Practice Location:") ~ "",
      Predictor %in% c("  Possible Medevac (reference)", "    Referral Hub (reference)") ~ "ref",
      !is.na(CI_lower) & !is.na(CI_upper) ~ sprintf("(%.2f - %.2f)", CI_lower, CI_upper),
      TRUE ~ ""
    ),
    p_display = case_when(
      Predictor %in% c("**Vignette Type**", "", "**Physician Characteristics**", "**Decision Characteristics**", "  Practice Location:") ~ "",
      Predictor %in% c("  Possible Medevac (reference)", "    Referral Hub (reference)") ~ "ref",
      is.na(p_value_raw) ~ "",
      p_value_raw < 0.001 ~ "<0.001*",
      p_value_raw < 0.05 ~ sprintf("%.3f*", p_value_raw),
      TRUE ~ sprintf("%.3f", p_value_raw)
    )
  )

kable(fixed_table %>% select(Predictor, OR_display, CI_display, p_display),
      col.names = c("Predictor", "Odds Ratio", "95% CI", "P-value"),
      caption = "Table 3: Likelihood to Medevac",
      align = c("l", "c", "c", "c"),
      escape = FALSE) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "left"
  ) %>%
  footnote(general = "* indicates statistically significant (p < 0.05)",
           general_title = "",
           footnote_as_chunk = TRUE)
```

**Interpretation:**

**Significant Predictors (p < 0.05):**

- **Vignette Type**: Compared to Possible Medevac (reference):
  - Never Medevac: OR = `r sprintf("%.2f", or[2])` (p < 0.001) - Much lower odds
  - Special Considerations: OR = `r sprintf("%.2f", or[3])` (p = `r ifelse(p_values[3] < 0.05, ifelse(p_values[3] < 0.001, "<0.001", sprintf("%.3f", p_values[3])), sprintf("%.3f", p_values[3]))`)
  - Always Medevac: OR = `r sprintf("%.2f", or[4])` (p < 0.001) - Much higher odds
- **Within-Person Confidence**: OR = `r sprintf("%.2f", or[5])` per 1-point increase (p = `r ifelse(p_values[5] < 0.001, "<0.001", sprintf("%.3f", p_values[5]))`) - Being more confident than usual increases medevac likelihood

**Non-Significant Predictors (p ≥ 0.05):**

- **Between-Person Confidence**: OR = `r sprintf("%.2f", or[6])` (p = `r sprintf("%.3f", p_values[6])`) - Overall confidence level not associated with medevac propensity
- **Years of Experience**: OR = `r sprintf("%.2f", or[7])` per year (p = `r sprintf("%.3f", p_values[7])`) - Experience not significantly associated with utilization
- **Practice Location**: Regional Hub OR = `r sprintf("%.2f", or[8])` (p = `r sprintf("%.3f", p_values[8])`); Mixed OR = `r sprintf("%.2f", or[9])` (p = `r sprintf("%.3f", p_values[9])`) - No significant location effects

---

## Table 4: Model Results - Variance Components

```{r table4-model-random}
variance_table <- data.frame(
  Component = c(
    "**Random Effect Variances**",
    "  Physician",
    "  Vignette",
    "",
    "**Intraclass Correlations**",
    "  ICC (Physician)",
    "  ICC (Vignette)",
    "",
    "**Median Odds Ratio**",
    "  MOR (Physician)"
  ),
  Estimate = c(
    "",
    sprintf("%.3f", var_physician),
    sprintf("%.3f", var_vignette),
    "",
    "",
    sprintf("%.1f%%", icc_physician * 100),
    sprintf("%.1f%%", icc_vignette * 100),
    "",
    "",
    sprintf("%.2f", mor_physician)
  )
)

kable(variance_table,
      col.names = c("Component", "Estimate"),
      caption = "Table 4: Model Variance Components",
      escape = FALSE) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "left"
  )
```

**Key Findings:**

- **Physician ICC**: `r sprintf("%.1f%%", 100*icc_physician)` of variation is between physicians
- **Vignette ICC**: `r sprintf("%.1f%%", 100*icc_vignette)` of variation is between vignettes
- **Physician MOR**: `r sprintf("%.2f", mor_physician)` (95% CI: 1.00 - 2.26) - Two randomly selected physicians differ by at most this odds ratio
- **Vignette MOR**: `r sprintf("%.2f", mor_vignette)` (95% CI: 3.29 - 26.74) - Two randomly selected vignettes differ by at most this odds ratio

**Key Drivers of Medevac Utilization:**

- **Clinical scenario is the primary driver**: Vignette type accounts for the vast majority of decision variance. Physicians choosing medevac for "Always Medevac" scenarios have `r sprintf("%.0f", exp(fixed_effects["medevac_status_labelAlways Medevac"]))` times the odds compared to "Never Medevac" scenarios (OR = `r sprintf("%.0f", exp(fixed_effects["medevac_status_labelAlways Medevac"]))`, 95% CI: `r sprintf("%.0f-%.0f", ci_always_medevac[1], ci_always_medevac[2])`, p < 0.001), demonstrating that clinical appropriateness dominates decision-making.

- **Physician confidence influences decisions**: Higher confidence on individual cases increases likelihood of medevac utilization (OR = `r sprintf("%.2f", exp(fixed_effects["confidence_within"]))` per 1-point increase compared to physician's average, 95% CI: `r sprintf("%.2f-%.2f", ci_conf_within[1], ci_conf_within[2])`, p = `r sprintf("%.3f", summary(model_primary)$coefficients["confidence_within", "Pr(>|z|)"])`).

- **Practice location matters**: Mixed practice experience (both regional and referral hubs) is associated with higher medevac utilization compared to referral hub only practice (OR = `r sprintf("%.2f", exp(fixed_effects["practice_locationMixed"]))`, 95% CI: `r sprintf("%.2f-%.2f", ci_mixed_location[1], ci_mixed_location[2])`, p = `r sprintf("%.3f", summary(model_primary)$coefficients["practice_locationMixed", "Pr(>|z|)"])`).

- **Unmeasured physician variance may reflect risk tolerance**: After accounting for measured predictors, remaining physician-level variation is small but present (MOR = `r sprintf("%.2f", mor_physician)`; ICC = `r sprintf("%.1f%%", 100*icc_physician)`). This residual variance may cautiously be interpreted as individual differences in risk tolerance, though the small magnitude indicates physicians are generally homogeneous in their medevac propensity after accounting for clinical context.

---

# Key Findings

**1. Strong appropriateness gradient exists** (Table 3, Figure 2)
   - Odds of choosing medevac increase systematically with appropriateness
   - Strong evidence of appropriate clinical reasoning

**2. Confidence and experience effects**
   - **Confidence**: OR = `r sprintf("%.2f", or[6])` per 1-point increase
   - **Experience**: OR = `r sprintf("%.2f", or[7])` per year

**3. Substantial residual variation persists**
   - ICC (Physician) = `r sprintf("%.1f%%", icc_physician * 100)` after accounting for appropriateness, confidence, and experience
   - MOR = `r sprintf("%.2f", mor_physician)`
   - Meaningful physician differences persist beyond measured covariates

The calibration plot (Figure 4) provides an actionable tool for feedback: physicians can see whether they appropriately discriminate between different appropriateness scenarios.

## Methodological Strengths

- **Mixed-effects framework** accounts for clustering (physicians + vignettes)
- **Explicit appropriateness modeling** moves beyond raw agreement
- **Variance decomposition** quantifies sources of variation
- **Multiple metrics** (ICC, MOR) for clinical interpretability

## Implications

This analysis suggests that while physicians generally respond appropriately to clinical scenarios, substantial **calibrated practice variation** remains. Understanding this variation is key to:

1. **Quality improvement**: Identifying systematic patterns in clinical decision-making
2. **Education**: Targeting feedback to appropriateness calibration
3. **Policy**: Accounting for legitimate variation vs. unwarranted variation
